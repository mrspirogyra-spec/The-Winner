<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Winner — MCQ</title>
<style>
  :root{--accent:#1b6;--bg:#f7f7fb;--card:#fff;--muted:#556}
  body{font-family:Inter, "Noto Sans Bengali", Arial, sans-serif;margin:0;background:var(--bg);color:#111}
  header{background:linear-gradient(90deg,#0b6b93,#0b94a9);color:#fff;padding:14px 18px;text-align:center;position:relative}
  header h1{margin:0;font-size:20px}
  .wrap{max-width:980px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border-radius:10px;padding:18px;box-shadow:0 8px 24px rgba(12,20,40,0.06)}
  .center{display:flex;flex-direction:column;align-items:center;gap:12px}
  button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  input[type=text], input[type=password], input[type=number], select, textarea, input[type=datetime-local]{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;font-size:14px;margin-top:6px}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .admin-link{position:absolute;right:18px;top:14px;background:transparent;border:1px solid rgba(255,255,255,.15);padding:8px 10px;color:#fff;border-radius:8px}
  .hidden{display:none}
  .question, .admin-question{border:1px solid #eee;border-radius:8px;padding:10px;margin:8px 0;background:#fff}
  .inline{display:inline-block;margin:6px 0}
  .timer{font-weight:700;color:#b00}
  .small{font-size:13px;color:#666}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #ddd;padding:6px;text-align:left;font-size:13px}
  th{background:#fafafa}
  pre {white-space:pre-wrap}
  .meta-line{font-size:13px;color:#444;margin-top:6px}
  @media(max-width:720px){ .row{flex-direction:column} }
  footer{margin-top:18px;text-align:center;font-size:13px;color:#333;padding-bottom:32px}
</style>
</head>
<body>
<header>
  <h1>Welcome to The Winner</h1>
  <button id="adminBtn" class="admin-link">প্রশাসক লগইন</button>
</header>

<div class="wrap">
  <!-- Home -->
  <div id="home" class="card center">
    <h2>The Winner</h2>
    <div><button id="startExamBtn">পরীক্ষা শুরু করুন</button></div>
  </div>

  <!-- Name / Choose exam -->
  <div id="nameScreen" class="card hidden">
    <div class="row" style="align-items:center">
      <div class="col">
        <label>আপনার নাম</label>
        <input id="candidateName" type="text" placeholder="আপনার নাম লিখুন" />
      </div>
      <div style="width:320px">
        <label>মডেল টেস্ট নির্বাচন</label>
        <select id="examSelect"></select>
        <div id="examTimes" class="meta-line"></div>
      </div>
    </div>
    <div style="margin-top:12px" class="actions">
      <button id="beginBtn">শুরু করুন</button>
      <button id="backToHome">Back</button>
    </div>
    <hr/>
    <div id="instrArea">
      <h4>পরীক্ষার নির্দেশনা</h4>
      <ol id="defaultInstr">
        <li>প্রতি ভুল উত্তরের জন্য নেগেটিভ মার্ক (০.৫/০.২৫) রয়েছে।</li>
        <li>সময় শেষ হলে অটোমেটিক সাবমিট হয়ে যাবে।</li>
        <li>একজন পরীক্ষার্থী এক বারের বেশি অংশগ্রহণ করতে পারবেন না। একাধিকবার চেষ্টা করলে ইউজার ব্লক হয়ে যাবে।</li>
        <li>এই সাইটটি এখনো পরীক্ষামূলক পর্যায়ে আছে তাই কিছু সমস্যা বা অসংগতি দেখা যেতে পারে।</li>
      </ol>
    </div>
  </div>

  <!-- Exam -->
  <div id="examScreen" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="examTitle">পরীক্ষা</h3>
      <div>
        <div id="examClock" class="meta-line"></div>
        <div class="timer" id="timerDisplay"></div>
      </div>
    </div>
    <div id="questionsArea" style="margin-top:12px"></div>
    <div style="text-align:center;margin-top:12px">
      <button id="submitExamBtn">জমা করুন</button>
    </div>
  </div>

  <!-- Result -->
  <div id="resultScreen" class="card hidden">
    <h3>ফলাফল</h3>
    <div id="summary" class="small"></div>
    <div style="margin-top:8px" class="actions">
      <button id="toggleMarksBtn">মার্কসহ উত্তর দেখুন</button>
      <button id="downloadCsvBtn">CSV ডাউনলোড</button>
    </div>
    <hr/>
    <div id="detailedAnswers"></div>
    <div style="text-align:right;margin-top:12px">
      <button id="backHomeBtn">Back</button>
    </div>
  </div>

  <!-- Admin Panel (modal-like) -->
  <div id="adminPanel" class="card hidden">
    <h3>প্রশাসক প্যানেল</h3>
    <div class="row">
      <div class="col"><button id="createPaperBtn">নতুন প্রশ্নপত্র তৈরি করুন</button></div>
      <div class="col"><button id="viewPapersBtn">বিগত প্রশ্নপত্র</button></div>
      <div class="col"><button id="viewLogBtn">লগ রেকর্ড</button></div>
    </div>

    <div style="margin-top:10px" class="row">
      <div class="col">
        <label>নতুন পাসওয়ার্ড (প্রবেশ করান ও পরিবর্তন করুন)</label>
        <input id="newPass" type="password" placeholder="নতুন পাসওয়ার্ড"/>
      </div>
      <div style="align-self:end"><button id="changePassBtn">পাসওয়ার্ড পরিবর্তন</button></div>
    </div>

    <div id="adminContent" style="margin-top:12px"></div>

    <div style="text-align:right;margin-top:12px"><button id="closeAdmin">Back</button></div>
  </div>

  <!-- Create paper area -->
  <div id="createPaperArea" class="card hidden">
    <h3>নতুন প্রশ্নপত্র</h3>
    <div class="row">
      <div class="col">
        <label>শিরোনাম</label>
        <input id="paperTitle" type="text" placeholder="উদাহরণ: গণিত - মে মাসিক" />
      </div>
      <div style="width:200px">
        <label>সময় (মিনিট) — 0 হলে সীমাহীন</label>
        <input id="paperDuration" type="number" min="0" value="0" />
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>Start Time</label>
        <input id="paperStart" type="datetime-local" />
      </div>
      <div style="width:260px">
        <label>End Time</label>
        <input id="paperEnd" type="datetime-local" />
      </div>
    </div>

    <div id="questionsEditor" style="margin-top:12px"></div>

    <div style="margin-top:12px" class="actions">
      <button id="addQuestionBtn">প্রশ্ন যোগ করুন</button>
      <button id="savePaperBtn">সংরক্ষণ</button>
      <button id="cancelCreateBtn">Back</button>
    </div>
  </div>

  <!-- Past papers area -->
  <div id="pastPapersArea" class="card hidden">
    <h3>বিগত প্রশ্নপত্র</h3>
    <div id="papersList"></div>
    <hr/>
    <div id="resultsArea"></div>
    <div style="text-align:right;margin-top:12px"><button id="closePastBtn">Back</button></div>
  </div>

  <!-- Logs -->
  <div id="logArea" class="card hidden">
    <h3>প্রশাসক লগ</h3>
    <div id="loginRecords"></div>
    <div style="text-align:right;margin-top:12px"><button id="closeLogBtn">Back</button></div>
  </div>

  <footer>
    <div>Developed by Subroto Howlader</div>
    <div style="color:blue">Copyright © 2025 The Winner</div>
  </footer>
</div>

<!-- Firebase (compat for simpler migration) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ---------------------------------------------
   Firebase config - use the config you provided
   --------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyA-b5BIOGNrJUsJfMsuIQtQaSSKPJf7GCM",
  authDomain: "the-winner-3e9ad.firebaseapp.com",
  projectId: "the-winner-3e9ad",
  storageBucket: "the-winner-3e9ad.firebasestorage.app",
  messagingSenderId: "805032110425",
  appId: "1:805032110425:web:ed69a6732983b023b9c448"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* -----------------------
   Global exam rules (placed in main code as requested)
   - modify these values here when needed
   ----------------------- */
const examRules = {
  totalTime: 30,                   // default total time in minutes if exam.duration == 0
  negativeMarking: true,           // enable negative marking by default
  negativePerQuestion: 0.25,       // default negative per wrong answer (used when question.negative not defined)
  maxAttempts: 1,                  // used for warning only (not enforced block)
  showCorrectAnswerAfterExam: true // whether to show correct answers after submission
};

/* -----------------------
   State
   ----------------------- */
let currentPaperId = null;
let candidateName = '';
let examQuestions = []; // runtime loaded from Firestore
let examTimer = null;
let timeLeftSeconds = 0;
let lastResult = null;
let showMarks = false;
const DEFAULT_PASS = 'admin123';

/* -----------------------
   Small helpers
   ----------------------- */
function el(tag, attrs={}, children=[]){
  const d = document.createElement(tag);
  for(const k in attrs){
    if(k==='class') d.className = attrs[k];
    else if(k==='text') d.textContent = attrs[k];
    else d.setAttribute(k, attrs[k]);
  }
  (Array.isArray(children)?children:[children]).forEach(c=>{ if(c===null||c===undefined) return; if(typeof c === 'string') d.appendChild(document.createTextNode(c)); else d.appendChild(c); });
  return d;
}
function escapeCsv(s){
  if(s===null||s===undefined) return '';
  const str = String(s).replace(/"/g,'""');
  return `"${str}"`;
}
function fmtDateTime(ts){
  if(!ts) return '';
  const d = (ts.toDate) ? ts.toDate() : new Date(ts);
  return d.toLocaleString();
}
function toFirestoreTimestampFromLocalValue(val){
  if(!val) return null;
  const d = new Date(val);
  return firebase.firestore.Timestamp.fromDate(d);
}

/* -----------------------
   UI refs
   ----------------------- */
const startExamBtn = document.getElementById('startExamBtn');
const adminBtn = document.getElementById('adminBtn');

const nameScreen = document.getElementById('nameScreen');
const candidateNameInput = document.getElementById('candidateName');
const examSelect = document.getElementById('examSelect');
const beginBtn = document.getElementById('beginBtn');
const backToHome = document.getElementById('backToHome');
const examTimes = document.getElementById('examTimes');

const examScreen = document.getElementById('examScreen');
const examTitleEl = document.getElementById('examTitle');
const examClock = document.getElementById('examClock');
const questionsArea = document.getElementById('questionsArea');
const submitExamBtn = document.getElementById('submitExamBtn');
const timerDisplay = document.getElementById('timerDisplay');

const resultScreen = document.getElementById('resultScreen');
const summaryEl = document.getElementById('summary');
const detailedAnswers = document.getElementById('detailedAnswers');
const toggleMarksBtn = document.getElementById('toggleMarksBtn');
const downloadCsvBtn = document.getElementById('downloadCsvBtn');
const backHomeBtn = document.getElementById('backHomeBtn');

const adminPanel = document.getElementById('adminPanel');
const createPaperBtn = document.getElementById('createPaperBtn');
const viewPapersBtn = document.getElementById('viewPapersBtn');
const viewLogBtn = document.getElementById('viewLogBtn');
const closeAdmin = document.getElementById('closeAdmin');
const changePassBtn = document.getElementById('changePassBtn');
const newPassInput = document.getElementById('newPass');
const adminContent = document.getElementById('adminContent');

const createPaperArea = document.getElementById('createPaperArea');
const paperTitleInput = document.getElementById('paperTitle');
const paperDurationInput = document.getElementById('paperDuration');
const paperStartInput = document.getElementById('paperStart');
const paperEndInput = document.getElementById('paperEnd');
const questionsEditor = document.getElementById('questionsEditor');
const addQuestionBtn = document.getElementById('addQuestionBtn');
const savePaperBtn = document.getElementById('savePaperBtn');
const cancelCreateBtn = document.getElementById('cancelCreateBtn');

const pastPapersArea = document.getElementById('pastPapersArea');
const papersList = document.getElementById('papersList');
const resultsArea = document.getElementById('resultsArea');
const closePastBtn = document.getElementById('closePastBtn');

const logArea = document.getElementById('logArea');
const loginRecords = document.getElementById('loginRecords');
const closeLogBtn = document.getElementById('closeLogBtn');

/* -----------------------
   Event wiring
   ----------------------- */
startExamBtn.addEventListener('click', ()=>{ showNameScreen(); });
adminBtn.addEventListener('click', ()=>{ promptAdminLogin(); });

backToHome.addEventListener('click', ()=>{ hideNameShowHome(); });
beginBtn.addEventListener('click', ()=>{ beginExamFlow(); });

submitExamBtn.addEventListener('click', ()=>{ if(confirm('আপনি কি পরীক্ষাটি সাবমিট করতে চান?')) submitExam(); });

toggleMarksBtn.addEventListener('click', ()=>{ showMarks = !showMarks; renderMarksToggle(); });
downloadCsvBtn.addEventListener('click', ()=>{ if(!lastResult) return alert('কোনো ফলাফলের ডেটা নেই'); downloadResultCsv(lastResult); });
backHomeBtn.addEventListener('click', ()=>{ goHome(); });

createPaperBtn.addEventListener('click', ()=>{ openCreatePaper(); });
viewPapersBtn.addEventListener('click', ()=>{ renderPapersList(); });
viewLogBtn.addEventListener('click', ()=>{ renderLogs(); });

closeAdmin.addEventListener('click', ()=>{ closeAdminPanel(); });
changePassBtn.addEventListener('click', ()=>{ changeAdminPass(); });

addQuestionBtn.addEventListener('click', ()=>{ addQuestionEditor(); });
savePaperBtn.addEventListener('click', ()=>{ saveCurrentPaper(); });
cancelCreateBtn.addEventListener('click', ()=>{ closeCreatePaper(); });

closePastBtn.addEventListener('click', ()=>{ document.getElementById('pastPapersArea').classList.add('hidden'); adminPanel.classList.remove('hidden'); resultsArea.innerHTML=''; });
closeLogBtn.addEventListener('click', ()=>{ document.getElementById('logArea').classList.add('hidden'); adminPanel.classList.remove('hidden'); });

/* -----------------------
   Admin auth & logs
   ----------------------- */
async function getAdminPass(){
  try{
    const doc = await db.collection('meta').doc('admin').get();
    if(doc.exists && doc.data().pass) return doc.data().pass;
  }catch(e){ console.error(e); }
  return DEFAULT_PASS;
}
async function setAdminPassFirestore(pw){
  await db.collection('meta').doc('admin').set({pass: pw});
}
async function changeAdminPass(){
  const np = newPassInput.value.trim();
  if(!np) return alert('নতুন পাসওয়ার্ড দিন');
  try{
    await setAdminPassFirestore(np);
    newPassInput.value='';
    alert('পাসওয়ার্ড পরিবর্তন হয়েছে');
    await recordAdminLogin('password-change');
  }catch(e){ alert('পাসওয়ার্ড পরিবর্তনে সমস্যা: '+e.message); }
}
async function promptAdminLogin(){
  const pw = prompt('প্রশাসক পাসওয়ার্ড লিখুন:'); if(pw===null) return;
  try{
    const real = await getAdminPass();
    if(pw === real){
      openAdminPanel();
      await recordAdminLogin('login');
    } else alert('পাসওয়ার্ড মিলেনি।');
  }catch(e){ console.error(e); alert('লগইন করতে সমস্যা: '+e.message); }
}
async function recordAdminLogin(type){
  try{
    await db.collection('adminLogs').add({type, time: firebase.firestore.FieldValue.serverTimestamp()});
  }catch(e){ console.error('log err', e); }
}
async function renderLogs(){
  adminPanel.classList.add('hidden');
  logArea.classList.remove('hidden');
  loginRecords.innerHTML = '';
  try{
    const snap = await db.collection('adminLogs').orderBy('time','desc').limit(100).get();
    if(snap.empty) return loginRecords.appendChild(el('div',{},['কোনো রেকর্ড নেই']));
    snap.forEach(doc=>{
      const d = doc.data();
      const ts = d.time ? d.time.toDate().toLocaleString() : '';
      loginRecords.appendChild(el('div',{},[`${d.type} — ${ts}`]));
    });
  }catch(e){ console.error(e); loginRecords.appendChild(el('div',{},['রেন্ডার করার সময় সমস্যা: '+e.message])); }
}

/* -----------------------
   Create paper editor (Firestore-backed)
   ----------------------- */
function openCreatePaper(){
  adminPanel.classList.add('hidden');
  createPaperArea.classList.remove('hidden');
  paperTitleInput.value = '';
  paperDurationInput.value = 0;
  paperStartInput.value = '';
  paperEndInput.value = '';
  questionsEditor.innerHTML = '';
  examQuestions = [];
  addQuestionEditor();
}
function closeCreatePaper(){
  createPaperArea.classList.add('hidden');
  adminPanel.classList.remove('hidden');
}
function addQuestionEditor(pref={}){
  const defaultQ = { q: pref.q || '', options: pref.options || ['','','',''], ans: pref.ans||0, point: pref.point||1, negative: (pref.negative!==undefined?pref.negative:examRules.negativePerQuestion) };
  examQuestions.push(defaultQ);
  renderQuestionsEditor();
}
function renderQuestionsEditor(){
  questionsEditor.innerHTML = '';
  examQuestions.forEach((item, idx)=>{
    const block = el('div',{class:'admin-question'});
    const qLabel = el('label',{},['প্রশ্ন:']);
    const qInput = el('input',{type:'text', value:item.q});
    qInput.style.marginTop = '6px';
    qInput.addEventListener('input', e=>{ examQuestions[idx].q = e.target.value; });
    block.appendChild(qLabel); block.appendChild(qInput);

    for(let i=0;i<4;i++){
      const optLabel = el('label',{},[`অপশন ${i+1}:`]);
      const optInput = el('input',{type:'text', value:item.options[i]});
      optInput.style.marginTop = '6px';
      optInput.addEventListener('input', e=>{ examQuestions[idx].options[i] = e.target.value; });
      block.appendChild(optLabel); block.appendChild(optInput);
    }

    const correctLabel = el('label',{},['সঠিক অপশন:']);
    const correctSelect = el('select',{});
    for(let v=0; v<4; v++){
      const opt = el('option',{value:v},[`অপশন ${v+1}`]);
      if(item.ans===v) opt.selected = true;
      correctSelect.appendChild(opt);
    }
    correctSelect.value = item.ans;
    correctSelect.addEventListener('change', e=>{ examQuestions[idx].ans = parseInt(e.target.value); });
    block.appendChild(correctLabel); block.appendChild(correctSelect);

    const pointLabel = el('label',{},['পয়েন্ট:']);
    const pointInput = el('input',{type:'number', min:0, value:item.point});
    pointInput.addEventListener('input', e=>{ examQuestions[idx].point = parseFloat(e.target.value) || 0; });
    block.appendChild(pointLabel); block.appendChild(pointInput);

    const negLabel = el('label',{},['ভুল হলে বিয়োগ:']);
    const negSelect = el('select',{});
    [0,0.25,0.5].forEach(v=>{
      const o = el('option',{value:v},[String(v)]);
      if(Number(item.negative) === Number(v)) o.selected = true;
      negSelect.appendChild(o);
    });
    negSelect.value = item.negative;
    negSelect.addEventListener('change', e=>{ examQuestions[idx].negative = parseFloat(e.target.value); });
    block.appendChild(negLabel); block.appendChild(negSelect);

    const delBtn = el('button',{},['প্রশ্ন মুছুন']);
    delBtn.style.marginTop = '8px';
    delBtn.addEventListener('click', ()=>{ if(confirm('মুছে ফেলতে চান?')){ examQuestions.splice(idx,1); renderQuestionsEditor(); }});
    block.appendChild(delBtn);

    questionsEditor.appendChild(block);
  });
}

/* -----------------------
   Save paper to Firestore (create or update)
   ----------------------- */
async function saveCurrentPaper(){
  const title = paperTitleInput.value.trim();
  if(!title) return alert('শিরোনাম দিন');
  if(examQuestions.length === 0) return alert('কমপক্ষে একটি প্রশ্ন যোগ করুন');
  for(const [i,q] of examQuestions.entries()){
    if(!q.q.trim()) return alert(`প্রশ্ন ${i+1} খালি আছে`);
    for(const [j,opt] of q.options.entries()){
      if(!String(opt).trim()) return alert(`প্রশ্ন ${i+1} এর অপশন ${j+1} খালি আছে`);
    }
  }
  const duration = Math.max(0, parseInt(paperDurationInput.value || 0));
  const startVal = paperStartInput.value;
  const endVal = paperEndInput.value;
  const startTS = toFirestoreTimestampFromLocalValue(startVal);
  const endTS = toFirestoreTimestampFromLocalValue(endVal);

  try{
    const editKey = createPaperArea.dataset.editKey;
    const payload = {
      title,
      questions: examQuestions.map(q => ({
        q: q.q,
        options: q.options,
        ans: Number(q.ans),
        point: Number(q.point||0),
        negative: (q.negative!==undefined?Number(q.negative): (examRules.negativeMarking ? examRules.negativePerQuestion : 0))
      })),
      created: firebase.firestore.FieldValue.serverTimestamp(),
      duration,
      startTime: startTS || null,
      endTime: endTS || null
    };
    if(editKey){
      await db.collection('exams').doc(editKey).set(payload, {merge:true});
      delete createPaperArea.dataset.editKey;
      alert('প্রশ্নপত্র আপডেট হয়েছে');
    } else {
      await db.collection('exams').add(payload);
      alert('প্রশ্নপত্র সংরক্ষণ হয়েছে');
    }
    paperTitleInput.value=''; paperDurationInput.value='0'; paperStartInput.value=''; paperEndInput.value='';
    examQuestions = []; renderQuestionsEditor();
    closeCreatePaper();
    populateExamSelect();
  }catch(e){
    console.error(e); alert('সেভ করতে সমস্যা: '+e.message);
  }
}

/* -----------------------
   List exams (admin view)
   ----------------------- */
async function renderPapersList(){
  adminPanel.classList.add('hidden');
  pastPapersArea.classList.remove('hidden');
  papersList.innerHTML = '';
  resultsArea.innerHTML = '';
  try{
    const snap = await db.collection('exams').orderBy('created','desc').get();
    if(snap.empty){ papersList.appendChild(el('div',{},['কোনো প্রশ্নপত্র সংরক্ষিত নেই'])); return; }
    snap.forEach(doc=>{
      const o = doc.data(); const k = doc.id;
      const row = el('div',{},[]); row.style.marginBottom='8px';
      const startStr = o.startTime ? fmtDateTime(o.startTime) : '—';
      const endStr = o.endTime ? fmtDateTime(o.endTime) : '—';
      const info = el('div',{},[ `${o.title} — ${o.questions.length} প্রশ্ন — সময়: ${o.duration} মিনিট — Start: ${startStr} — End: ${endStr}` ]);
      const btnLoad = el('button',{},['ইডিট/দেখুন']);
      btnLoad.addEventListener('click', ()=>{ loadPaperForAdmin(k); });
      const btnCopy = el('button',{},['লিংক কপি']);
      btnCopy.addEventListener('click', ()=>{ copyExamLink(k); });
      const btnPdf = el('button',{},['Make PDF']);
      btnPdf.addEventListener('click', ()=>{ makeExamPdf(k); });
      const btnReport = el('button',{},['রিপোর্ট দেখুন']);
      btnReport.addEventListener('click', ()=>{ renderResultsForExam(k); });
      const btnDelete = el('button',{},['ডিলিট']);
      btnDelete.addEventListener('click', async ()=>{ if(confirm('মুছে ফেলবেন?')){ await db.collection('exams').doc(k).delete(); const resSnap = await db.collection('exams').doc(k).collection('results').get(); const batch = db.batch(); resSnap.forEach(d=> batch.delete(d.ref)); await batch.commit().catch(()=>{}); renderPapersList(); populateExamSelect(); }});
      const actions = el('div',{class:'actions'},[btnLoad, btnCopy, btnPdf, btnReport, btnDelete]);
      row.appendChild(info); row.appendChild(actions); papersList.appendChild(row);
    });
  }catch(e){ console.error(e); papersList.appendChild(el('div',{},['লোড করতে সমস্যা: '+e.message])); }
}

async function loadPaperForAdmin(id){
  try{
    const doc = await db.collection('exams').doc(id).get();
    if(!doc.exists) return alert('প্রশ্নপত্র পাওয়া যায়নি');
    const o = doc.data();
    adminPanel.classList.add('hidden');
    createPaperArea.classList.remove('hidden');
    paperTitleInput.value = o.title || '';
    paperDurationInput.value = o.duration || 0;
    paperStartInput.value = o.startTime ? new Date(o.startTime.toDate()).toISOString().slice(0,16) : '';
    paperEndInput.value = o.endTime ? new Date(o.endTime.toDate()).toISOString().slice(0,16) : '';
    examQuestions = JSON.parse(JSON.stringify(o.questions || []));
    renderQuestionsEditor();
    createPaperArea.dataset.editKey = id;
  }catch(e){ console.error(e); alert('লোড করতে সমস্যা: '+e.message); }
}

/* -----------------------
   Copy link
   ----------------------- */
function copyExamLink(key){
  const url = window.location.href.split('#')[0].split('?')[0] + '?exam=' + encodeURIComponent(key);
  navigator.clipboard?.writeText(url).then(()=>{ alert('লিংক কপি হয়েছে:\n' + url); }).catch(()=>{ prompt('কপি করুন: Ctrl+C', url); });
}

/* -----------------------
   Make PDF from exam (uses jsPDF)
   ----------------------- */
async function makeExamPdf(examId){
  try{
    const docSnap = await db.collection('exams').doc(examId).get();
    if(!docSnap.exists) return alert('প্রশ্নপত্র পাওয়া যায়নি');
    const data = docSnap.data();
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.setFontSize(14);
    pdf.text(data.title || 'Exam', 14, 20);
    pdf.setFontSize(10);
    let y = 30;
    data.questions.forEach((q, idx)=>{
      const text = `${idx+1}. ${q.q}`;
      pdf.text(text, 14, y); y += 6;
      q.options.forEach((op, j)=>{
        pdf.text(`   ${String.fromCharCode(65+j)}. ${op}`, 16, y); y += 6;
      });
      y += 2;
      if(y > 270){ pdf.addPage(); y = 20; }
    });
    pdf.save((data.title || 'exam') + '.pdf');
  }catch(e){ console.error(e); alert('PDF তৈরিতে সমস্যা: '+e.message); }
}

/* -----------------------
   Populate exam select (user)
   ----------------------- */
async function populateExamSelect(){
  examSelect.innerHTML = '';
  try{
    const snap = await db.collection('exams').orderBy('created','desc').get();
    if(snap.empty){ examSelect.appendChild(el('option',{value:''},['প্রশাসক প্রথমে প্রশ্নপত্র তৈরি করুন'])); return; }
    snap.forEach(doc=>{
      const o = doc.data();
      examSelect.appendChild(el('option',{value:doc.id},[o.title]));
    });
    examSelect.addEventListener('change', ()=>{ showExamTimes(examSelect.value); });
    showExamTimes(examSelect.value);
  }catch(e){ console.error(e); examSelect.appendChild(el('option',{value:''},['লোড করতে সমস্যা'])); }
}
async function showExamTimes(examId){
  if(!examId){ examTimes.textContent = ''; return; }
  try{
    const doc = await db.collection('exams').doc(examId).get();
    if(!doc.exists){ examTimes.textContent = ''; return; }
    const o = doc.data();
    const start = o.startTime ? fmtDateTime(o.startTime) : '—';
    const end = o.endTime ? fmtDateTime(o.endTime) : '—';
    examTimes.textContent = `Start: ${start} — End: ${end}`;
  }catch(e){ examTimes.textContent = ''; }
}

/* -----------------------
   Begin exam flow (user) with time checks and attempts warning
   ----------------------- */
async function beginExamFlow(){
  candidateName = candidateNameInput.value.trim();
  if(!candidateName) return alert('নাম লিখুন');
  const key = examSelect.value;
  if(!key) return alert('প্রশাসক প্রথমে প্রশ্নপত্র তৈরি করুন');
  currentPaperId = key;
  try{
    const doc = await db.collection('exams').doc(key).get();
    if(!doc.exists) return alert('প্রশ্নপত্র পাওয়া যায়নি');
    const paper = doc.data();
    const now = firebase.firestore.Timestamp.fromDate(new Date());
    if(paper.startTime && now.seconds < paper.startTime.seconds){
      return alert('এই মডেল টেস্ট এখনও শুরু হয়নি।');
    }
    if(paper.endTime && now.seconds > paper.endTime.seconds){
      return alert('এই মডেল টেস্ট শেষ হয়েছে।');
    }

    // attempt count (warning only if >= maxAttempts)
    const attemptsSnap = await db.collection('exams').doc(key).collection('results').where('candidate','==',candidateName).get();
    if(!attemptsSnap.empty && attemptsSnap.size >= (examRules.maxAttempts || 1)){
      // warning only — not enforcing block
      alert(`সতর্কতা: আপনি ইতিপূর্বে এই পরীক্ষায় ${attemptsSnap.size} বার অংশগ্রহণ করেছেন। (নীচে নির্দেশনায় একাধিকবার অংশগ্রহণ নাও করার কথা বলা আছে)`);
    }

    // load questions and start exam
    examQuestions = JSON.parse(JSON.stringify(paper.questions || []));
    // ensure each question has negative defined
    examQuestions = examQuestions.map(q => {
      return {
        q: q.q,
        options: q.options,
        ans: Number(q.ans),
        point: Number(q.point || 0),
        negative: (q.negative !== undefined && q.negative !== null) ? Number(q.negative) : (examRules.negativeMarking ? examRules.negativePerQuestion : 0)
      };
    });

    // compute duration seconds: prefer paper.duration, else examRules.totalTime, else 0
    const durationSecFromPaper = (paper.duration && Number(paper.duration) > 0) ? Number(paper.duration) * 60 : 0;
    const defaultDurationSec = (examRules.totalTime && Number(examRules.totalTime) > 0) ? Number(examRules.totalTime) * 60 : 0;

    nameScreen.classList.add('hidden');
    renderExam(paper.title);
    examScreen.classList.remove('hidden');

    examClock.textContent = `Start: ${paper.startTime ? fmtDateTime(paper.startTime) : '—'} — End: ${paper.endTime ? fmtDateTime(paper.endTime) : '—'}`;

    // Effective time left: if paper has endTime, cap at that
    let desiredSeconds = durationSecFromPaper || defaultDurationSec || 0;
    if(paper.endTime){
      const nowMs = Date.now();
      const endMs = paper.endTime.toDate().getTime();
      const maxLeft = Math.floor((endMs - nowMs)/1000);
      if(maxLeft <= 0) return alert('এই মডেল টেস্ট শেষ হয়েছে।');
      if(desiredSeconds > 0) timeLeftSeconds = Math.min(desiredSeconds, maxLeft);
      else timeLeftSeconds = maxLeft;
    } else {
      timeLeftSeconds = desiredSeconds;
    }

    if(timeLeftSeconds > 0) startTimer(timeLeftSeconds);
    else timerDisplay.textContent = '';
  }catch(e){ console.error(e); alert('প্রশ্নপত্র লোড করতে সমস্যা: '+e.message); }
}

/* -----------------------
   Render exam & timer
   ----------------------- */
function renderExam(title){
  examTitleEl.textContent = title || 'পরীক্ষা';
  questionsArea.innerHTML = '';
  examQuestions.forEach((q, i)=>{
    const qblock = el('div',{class:'question'});
    qblock.appendChild(el('div',{},[`${i+1}. ${q.q}`]));
    const opts = el('div');
    q.options.forEach((opt, j)=>{
      const id = `q_${i}_${j}`;
      const radio = el('input',{type:'radio', name:`q${i}`, value:j, id:id});
      const label = el('label',{},[ ' ', opt ]);
      const line = el('div');
      line.appendChild(radio); line.appendChild(label);
      opts.appendChild(line);
    });
    qblock.appendChild(opts);
    questionsArea.appendChild(qblock);
  });
}

function startTimer(seconds){
  clearInterval(examTimer);
  timeLeftSeconds = seconds;
  updateTimerDisplay();
  examTimer = setInterval(()=>{
    timeLeftSeconds--;
    updateTimerDisplay();
    if(timeLeftSeconds <= 0){
      clearInterval(examTimer);
      alert('সময় শেষ — পরীক্ষা স্বয়ংক্রিয়ভাবে সাবমিট হচ্ছে।');
      submitExam();
    }
  }, 1000);
}
function updateTimerDisplay(){
  if(timeLeftSeconds <= 0){ timerDisplay.textContent = ''; return; }
  const m = Math.floor(timeLeftSeconds / 60);
  const s = timeLeftSeconds % 60;
  timerDisplay.textContent = `বাকি সময়: ${m}m ${s}s`;
}

/* -----------------------
   Submit & scoring -> save result to Firestore
   ----------------------- */
async function submitExam(){
  clearInterval(examTimer);
  try{
    let correct = 0, wrong = 0;
    let totalScore = 0;
    const perQuestion = [];
    const answers = [];
    examQuestions.forEach((q, idx)=>{
      const sel = document.querySelector(`input[name="q${idx}"]:checked`);
      const chosen = sel ? parseInt(sel.value) : null;
      answers.push(chosen);
      if(chosen === null){ perQuestion.push(0); }
      else if(chosen === q.ans){ correct++; totalScore += Number(q.point || 0); perQuestion.push(Number(q.point||0)); }
      else { wrong++; const neg = (q.negative !== undefined && q.negative !== null) ? Number(q.negative) : (examRules.negativeMarking ? examRules.negativePerQuestion : 0); totalScore -= neg; perQuestion.push(-neg); }
    });
    // save to subcollection with server timestamp
    const payload = { candidate: candidateName, total: totalScore, correct, wrong, perQuestion, answers, date: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection('exams').doc(currentPaperId).collection('results').add(payload);
    // fetch latest saved doc to show date
    const resSnap = await db.collection('exams').doc(currentPaperId).collection('results').where('candidate','==',candidateName).orderBy('date','desc').limit(1).get();
    if(!resSnap.empty){
      const saved = resSnap.docs[0].data();
      saved.date = saved.date ? saved.date.toDate().toISOString() : new Date().toISOString();
      lastResult = Object.assign({}, saved, {paperId: currentPaperId});
    } else {
      lastResult = { paperId: currentPaperId, candidate: candidateName, date: new Date().toISOString(), total: totalScore, correct, wrong, perQuestion, answers };
    }
    examScreen.classList.add('hidden');
    resultScreen.classList.remove('hidden');
    summaryEl.innerHTML = `<div>সঠিক: <strong>${correct}</strong> — ভুল: <strong>${wrong}</strong></div><div style="margin-top:6px">মোট প্রাপ্ত নম্বর: <strong>${Number(totalScore).toString()}</strong></div>`;
    renderDetailedAnswers();
  }catch(e){ console.error(e); alert('সাবমিট করতে সমস্যা: '+e.message); }
}

/* -----------------------
   Render detailed answers & CSV (participant)
   ----------------------- */
function renderDetailedAnswers(){
  detailedAnswers.innerHTML = '';
  if(!lastResult) return;
  examQuestions.forEach((q, idx)=>{
    const block = el('div',{class:'question'});
    const userAns = lastResult.answers[idx] === null || lastResult.answers[idx] === undefined ? 'উত্তর নেই' : q.options[lastResult.answers[idx]];
    const correctAns = q.options[q.ans];
    const score = lastResult.perQuestion[idx];
    block.appendChild(el('div',{},[ `${idx+1}. ${q.q}` ]));
    block.appendChild(el('div',{class:'small'},[`আপনার উত্তর: ${userAns}`]));
    block.appendChild(el('div',{class:'small'},[`সঠিক উত্তর: ${correctAns}`]));
    block.appendChild(el('div',{class:'small mark-line'},[`এই প্রশ্নের প্রাপ্ত নম্বর: ${score}`]));
    block.appendChild(el('div',{class:'small'},[`অবস্থা: ${score>0 ? 'সঠিক' : (score===0 ? 'উত্তর নেই' : 'ভুল')}`]));
    detailedAnswers.appendChild(block);
  });
  renderMarksToggle();
}
function renderMarksToggle(){
  const markLines = detailedAnswers.querySelectorAll('.mark-line');
  markLines.forEach(elm=>elm.style.display = showMarks ? 'block' : 'none');
  toggleMarksBtn.textContent = showMarks ? 'মার্ক লুকান' : 'মার্কসহ উত্তর দেখুন';
}
function downloadResultCsv(result){
  const rows = [];
  rows.push(['Question','YourAnswer','CorrectAnswer','Score']);
  examQuestions.forEach((q, idx)=>{
    const your = result.answers[idx]===null || result.answers[idx]===undefined ? '' : q.options[result.answers[idx]];
    rows.push([q.q, your, q.options[q.ans], String(result.perQuestion[idx])]);
  });
  const csv = rows.map(r => r.map(c=>escapeCsv(c)).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  const filename = (/*paper title fetch*/ 'result') + '_' + (result.candidate || 'candidate') + '.csv';
  a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}

/* -----------------------
   Admin: results listing (Name | Score)
   ----------------------- */
async function renderResultsForExam(examId){
  resultsArea.innerHTML = '';
  try{
    const doc = await db.collection('exams').doc(examId).get();
    if(!doc.exists) return alert('প্রশ্নপত্র পাওয়া যায়নি');
    const paper = doc.data();
    const title = el('h4',{},[ `${paper.title} — রিপোর্ট` ]);
    const btnExport = el('button',{},['Export CSV']);
    btnExport.addEventListener('click', ()=>{ exportExamResultsCsv(examId); });
    const btnBack = el('button',{},['Back to list']);
    btnBack.addEventListener('click', ()=>{ resultsArea.innerHTML=''; });
    resultsArea.appendChild(title); resultsArea.appendChild(btnExport); resultsArea.appendChild(btnBack);

    const snap = await db.collection('exams').doc(examId).collection('results').orderBy('date','desc').get();
    if(snap.empty){ resultsArea.appendChild(el('div',{},['কোনো অংশগ্রহণকারীর ফলাফল নেই'])); return; }
    const table = el('table');
    const thead = el('thead'); const headerRow = el('tr');
    ['#','Name','Score'].forEach(h=> headerRow.appendChild(el('th',{},[h])));
    thead.appendChild(headerRow); table.appendChild(thead);
    const tbody = el('tbody');
    let idx = 1;
    snap.forEach(doc=>{
      const r = doc.data();
      const tr = el('tr');
      tr.appendChild(el('td',{},[String(idx++)]));
      tr.appendChild(el('td',{},[r.candidate || '']));
      tr.appendChild(el('td',{},[ String(r.total) ]));
      tbody.appendChild(tr);
    });
    table.appendChild(tbody); resultsArea.appendChild(table);
  }catch(e){ console.error(e); resultsArea.appendChild(el('div',{},['লোড করতে সমস্যা: '+e.message])); }
}

/* -----------------------
   Export results CSV (admin)
   ----------------------- */
async function exportExamResultsCsv(examId){
  try{
    const examDoc = await db.collection('exams').doc(examId).get();
    if(!examDoc.exists) return alert('প্রশ্নপত্র পাওয়া যায়নি');
    const paper = examDoc.data();
    const snap = await db.collection('exams').doc(examId).collection('results').orderBy('date','desc').get();
    if(snap.empty) return alert('কোনো ফলাফল নেই');
    const headers = ['Name','Date','Total','Correct','Wrong'];
    for(let i=0;i<paper.questions.length;i++){
      headers.push(`Q${i+1}_Your`); headers.push(`Q${i+1}_Correct`); headers.push(`Q${i+1}_Score`);
    }
    const rows = [headers];
    snap.forEach(doc=>{
      const r = doc.data();
      const row = [r.candidate || '', (r.date? r.date.toDate().toISOString():''), String(r.total), String(r.correct), String(r.wrong)];
      for(let q=0;q<paper.questions.length;q++){
        const your = (r.answers && r.answers[q] !== undefined && r.answers[q] !== null) ? (paper.questions[q].options[r.answers[q]] || '') : '';
        const correct = paper.questions[q].options[paper.questions[q].ans] || '';
        const score = String((r.perQuestion && r.perQuestion[q]) || 0);
        row.push(your, correct, score);
      }
      rows.push(row);
    });
    const csv = rows.map(r => r.map(c=>escapeCsv(c)).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = (paper.title || 'exam') + '_results.csv'; a.click(); URL.revokeObjectURL(a.href);
  }catch(e){ console.error(e); alert('Export error: '+e.message); }
}

/* -----------------------
   Page load handling (query param)
   ----------------------- */
async function handleQueryParam(){
  const params = new URLSearchParams(window.location.search);
  const examParam = params.get('exam');
  await populateExamSelect();
  if(examParam){
    const option = Array.from(examSelect.options).find(o=>o.value===examParam);
    if(option){
      showNameScreen();
      examSelect.value = examParam;
      showExamTimes(examParam);
    }
  }
}
window.addEventListener('load', ()=>{ handleQueryParam().catch(e=>console.error(e)); });

/* -----------------------
   Navigation helpers
   ----------------------- */
function showNameScreen(){ document.getElementById('home').classList.add('hidden'); populateExamSelect(); nameScreen.classList.remove('hidden'); }
function hideNameShowHome(){ nameScreen.classList.add('hidden'); document.getElementById('home').classList.remove('hidden'); }
function goHome(){ clearInterval(examTimer); timerDisplay.textContent=''; resultScreen.classList.add('hidden'); examScreen.classList.add('hidden'); nameScreen.classList.add('hidden'); createPaperArea.classList.add('hidden'); pastPapersArea.classList.add('hidden'); resultsArea.innerHTML=''; logArea.classList.add('hidden'); adminPanel.classList.add('hidden'); document.getElementById('home').classList.remove('hidden'); }

/* -----------------------
   Expose helpers (debug)
   ----------------------- */
window._tw = { makeExamPdf, populateExamSelect };
</script>
</body>
</html>