<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Winner — MCQ</title>
<style>
  :root{--accent:#1b6;--bg:#f7f7fb;--card:#fff;--muted:#556}
  body{font-family:Inter, "Noto Sans Bengali", Arial, sans-serif;margin:0;background:var(--bg);color:#111}
  header{background:linear-gradient(90deg,#0b6b93,#0b94a9);color:#fff;padding:14px 18px;text-align:center}
  header h1{margin:0;font-size:20px}
  .wrap{max-width:980px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border-radius:10px;padding:18px;box-shadow:0 8px 24px rgba(12,20,40,0.06)}
  .center{display:flex;flex-direction:column;align-items:center;gap:12px}
  button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  input[type=text], input[type=password], input[type=number], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;font-size:14px;margin-top:6px}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .admin-link{position:absolute;right:18px;top:14px;background:transparent;border:1px solid rgba(255,255,255,.15);padding:8px 10px;color:#fff;border-radius:8px}
  .hidden{display:none}
  .question, .admin-question{border:1px solid #eee;border-radius:8px;padding:10px;margin:8px 0;background:#fff}
  .inline{display:inline-block;margin:6px 0}
  .timer{font-weight:700;color:#b00}
  .small{font-size:13px;color:#666}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #ddd;padding:6px;text-align:left;font-size:13px}
  th{background:#fafafa}
  pre {white-space:pre-wrap}
  @media(max-width:720px){ .row{flex-direction:column} }
  footer{margin-top:18px;text-align:center;font-size:13px;color:#333}
</style>
</head>
<body>
<header>
  <h1>Welcome to The Winner</h1>
  <button id="adminBtn" class="admin-link">প্রশাসক লগইন</button>
</header>

<div class="wrap">
  <!-- Home -->
  <div id="home" class="card center">
    <h2>The Winner</h2>
    <div><button id="startExamBtn">পরীক্ষা শুরু করুন</button></div>
  </div>

  <!-- Name / Choose exam -->
  <div id="nameScreen" class="card hidden">
    <div class="row" style="align-items:center">
      <div class="col">
        <label>আপনার নাম</label>
        <input id="candidateName" type="text" placeholder="আপনার নাম লিখুন" />
      </div>
      <div style="width:220px">
        <label>মডেল টেস্ট নির্বাচন</label>
        <select id="examSelect"></select>
      </div>
    </div>
    <div style="margin-top:12px" class="actions">
      <button id="beginBtn">শুরু করুন</button>
      <button id="backToHome">Back</button>
    </div>
    <hr/>
    <div id="instrArea">
      <h4>পরীক্ষার নির্দেশনা</h4>
      <ol id="defaultInstr">
        <li>প্রতি ভুল উত্তরের জন্য নেগেটিভ মার্ক (০.৫/০.২৫) রয়েছে।</li>
        <li>সময় শেষ হলে অটোমেটিক সাবমিট হয়ে যাবে।</li>
        <li>একজন পরীক্ষার্থী এক বারের বেশি অংশগ্রহণ করতে পারবেন না। একাধিকবার চেষ্টা করলে ইউজার ব্লক হয়ে যাবে।</li>
        <li>এই সাইটটি এখনো পরীক্ষামূলক পর্যায়ে আছে তাই কিছু সমস্যা বা অসংগতি দেখা যেতে পারে।</li>
      </ol>
    </div>
  </div>

  <!-- Exam -->
  <div id="examScreen" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="examTitle">পরীক্ষা</h3>
      <div class="timer" id="timerDisplay"></div>
    </div>
    <div id="questionsArea" style="margin-top:12px"></div>
    <div style="text-align:center;margin-top:12px">
      <button id="submitExamBtn">জমা করুন</button>
    </div>
  </div>

  <!-- Result -->
  <div id="resultScreen" class="card hidden">
    <h3>ফলাফল</h3>
    <div id="summary" class="small"></div>
    <div style="margin-top:8px" class="actions">
      <button id="toggleMarksBtn">মার্কসহ উত্তর দেখুন</button>
      <button id="downloadCsvBtn">CSV ডাউনলোড</button>
    </div>
    <hr/>
    <div id="detailedAnswers"></div>
    <div style="text-align:right;margin-top:12px">
      <button id="backHomeBtn">Back</button>
    </div>
  </div>

  <!-- Admin Panel (modal-like) -->
  <div id="adminPanel" class="card hidden">
    <h3>প্রশাসক প্যানেল</h3>
    <div class="row">
      <div class="col"><button id="createPaperBtn">নতুন প্রশ্নপত্র তৈরি করুন</button></div>
      <div class="col"><button id="viewPapersBtn">বিগত প্রশ্নপত্র</button></div>
      <div class="col"><button id="viewLogBtn">লগ রেকর্ড</button></div>
    </div>

    <div style="margin-top:10px" class="row">
      <div class="col">
        <label>নতুন পাসওয়ার্ড (প্রবেশ করান ও পরিবর্তন করুন)</label>
        <input id="newPass" type="password" placeholder="নতুন পাসওয়ার্ড"/>
      </div>
      <div style="align-self:end"><button id="changePassBtn">পাসওয়ার্ড পরিবর্তন</button></div>
    </div>

    <div id="adminContent" style="margin-top:12px"></div>

    <div style="text-align:right;margin-top:12px"><button id="closeAdmin">Back</button></div>
  </div>

  <!-- Create paper area -->
  <div id="createPaperArea" class="card hidden">
    <h3>নতুন প্রশ্নপত্র</h3>
    <div class="row">
      <div class="col">
        <label>শিরোনাম</label>
        <input id="paperTitle" type="text" placeholder="উদাহরণ: গণিত - মে মাসিক" />
      </div>
      <div style="width:200px">
        <label>সময় (মিনিট) — 0 হলে সীমাহীন</label>
        <input id="paperDuration" type="number" min="0" value="0" />
      </div>
    </div>

    <div id="questionsEditor" style="margin-top:12px"></div>

    <div style="margin-top:12px" class="actions">
      <button id="addQuestionBtn">প্রশ্ন যোগ করুন</button>
      <button id="savePaperBtn">সংরক্ষণ</button>
      <button id="cancelCreateBtn">Back</button>
    </div>
  </div>

  <!-- Past papers area -->
  <div id="pastPapersArea" class="card hidden">
    <h3>বিগত প্রশ্নপত্র</h3>
    <div id="papersList"></div>
    <hr/>
    <div id="resultsArea"></div>
    <div style="text-align:right;margin-top:12px"><button id="closePastBtn">Back</button></div>
  </div>

  <!-- Logs -->
  <div id="logArea" class="card hidden">
    <h3>প্রশাসক লগ</h3>
    <div id="loginRecords"></div>
    <div style="text-align:right;margin-top:12px"><button id="closeLogBtn">Back</button></div>
  </div>

  <footer>
    <div>Developed by Subroto Howlader</div>
    <div>Copyright © 2025</div>
  </footer>
</div>

<script>
/* -----------------------
   Utilities & state
   ----------------------- */
const PAP_PREFIX = 'exam_';
const ADMIN_LOG = 'tw_admin_log';
const ADMIN_PASS_KEY = 'tw_admin_pass';
const DEFAULT_PASS = 'admin123';

let currentPaper = null;
let candidateName = '';
let examQuestions = []; // runtime
let examTimer = null;
let timeLeftSeconds = 0;
let lastResult = null;
let showMarks = false;

function getAdminPass(){ return localStorage.getItem(ADMIN_PASS_KEY) || DEFAULT_PASS; }
function setAdminPass(pw){ localStorage.setItem(ADMIN_PASS_KEY, pw); }
function getPapersKeys(){ return Object.keys(localStorage).filter(k=>k.startsWith(PAP_PREFIX)).sort().reverse(); }
function savePaperObj(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function readPaperObj(key){ try{ return JSON.parse(localStorage.getItem(key)); } catch(e){ return null; } }

/* -----------------------
   Small helpers
   ----------------------- */
function el(tag, attrs={}, children=[]){
  const d = document.createElement(tag);
  for(const k in attrs){
    if(k==='class') d.className = attrs[k];
    else if(k==='text') d.textContent = attrs[k];
    else d.setAttribute(k, attrs[k]);
  }
  (Array.isArray(children)?children:[children]).forEach(c=>{ if(!c) return; if(typeof c === 'string') d.appendChild(document.createTextNode(c)); else d.appendChild(c); });
  return d;
}
function escapeCsv(s){
  if(s===null||s===undefined) return '';
  const str = String(s).replace(/"/g,'""');
  return `"${str}"`;
}

/* -----------------------
   UI references
   ----------------------- */
const home = document.getElementById('home');
const startExamBtn = document.getElementById('startExamBtn');
const adminBtn = document.getElementById('adminBtn');

const nameScreen = document.getElementById('nameScreen');
const candidateNameInput = document.getElementById('candidateName');
const examSelect = document.getElementById('examSelect');
const beginBtn = document.getElementById('beginBtn');
const backToHome = document.getElementById('backToHome');

const examScreen = document.getElementById('examScreen');
const examTitleEl = document.getElementById('examTitle');
const questionsArea = document.getElementById('questionsArea');
const submitExamBtn = document.getElementById('submitExamBtn');
const timerDisplay = document.getElementById('timerDisplay');

const resultScreen = document.getElementById('resultScreen');
const summaryEl = document.getElementById('summary');
const detailedAnswers = document.getElementById('detailedAnswers');
const toggleMarksBtn = document.getElementById('toggleMarksBtn');
const downloadCsvBtn = document.getElementById('downloadCsvBtn');
const backHomeBtn = document.getElementById('backHomeBtn');

const adminPanel = document.getElementById('adminPanel');
const createPaperBtn = document.getElementById('createPaperBtn');
const viewPapersBtn = document.getElementById('viewPapersBtn');
const viewLogBtn = document.getElementById('viewLogBtn');
const closeAdmin = document.getElementById('closeAdmin');
const changePassBtn = document.getElementById('changePassBtn');
const newPassInput = document.getElementById('newPass');
const adminContent = document.getElementById('adminContent');

const createPaperArea = document.getElementById('createPaperArea');
const paperTitleInput = document.getElementById('paperTitle');
const paperDurationInput = document.getElementById('paperDuration');
const questionsEditor = document.getElementById('questionsEditor');
const addQuestionBtn = document.getElementById('addQuestionBtn');
const savePaperBtn = document.getElementById('savePaperBtn');
const cancelCreateBtn = document.getElementById('cancelCreateBtn');

const pastPapersArea = document.getElementById('pastPapersArea');
const papersList = document.getElementById('papersList');
const resultsArea = document.getElementById('resultsArea');
const closePastBtn = document.getElementById('closePastBtn');

const logArea = document.getElementById('logArea');
const loginRecords = document.getElementById('loginRecords');
const closeLogBtn = document.getElementById('closeLogBtn');

/* -----------------------
   Init / event wiring
   ----------------------- */
startExamBtn.addEventListener('click', ()=>{ showNameScreen(); });
adminBtn.addEventListener('click', ()=>{ promptAdminLogin(); });

backToHome.addEventListener('click', ()=>{ hideNameShowHome(); });
beginBtn.addEventListener('click', ()=>{ beginExamFlow(); });

submitExamBtn.addEventListener('click', ()=>{ if(confirm('আপনি কি পরীক্ষাটি সাবমিট করতে চান?')) submitExam(); });

toggleMarksBtn.addEventListener('click', ()=>{ showMarks = !showMarks; renderMarksToggle(); });
downloadCsvBtn.addEventListener('click', ()=>{ if(!lastResult) return alert('কোনো ফলাফলের ডেটা নেই'); downloadResultCsv(lastResult); });
backHomeBtn.addEventListener('click', ()=>{ goHome(); });

createPaperBtn.addEventListener('click', ()=>{ openCreatePaper(); });
viewPapersBtn.addEventListener('click', ()=>{ renderPapersList(); });
viewLogBtn.addEventListener('click', ()=>{ renderLogs(); });

closeAdmin.addEventListener('click', ()=>{ closeAdminPanel(); });
changePassBtn.addEventListener('click', ()=>{ const np = newPassInput.value.trim(); if(!np) return alert('নতুন পাসওয়ার্ড দিন'); setAdminPass(np); newPassInput.value=''; alert('পাসওয়ার্ড পরিবর্তন হয়েছে'); recordAdminLogin('password-change'); });

addQuestionBtn.addEventListener('click', ()=>{ addQuestionEditor(); });
savePaperBtn.addEventListener('click', ()=>{ saveCurrentPaper(); });
cancelCreateBtn.addEventListener('click', ()=>{ closeCreatePaper(); });

closePastBtn.addEventListener('click', ()=>{ document.getElementById('pastPapersArea').classList.add('hidden'); adminPanel.classList.remove('hidden'); resultsArea.innerHTML=''; });
closeLogBtn.addEventListener('click', ()=>{ document.getElementById('logArea').classList.add('hidden'); adminPanel.classList.remove('hidden'); });

/* -----------------------
   Navigation helpers
   ----------------------- */
function showNameScreen(){
  home.classList.add('hidden');
  populateExamSelect();
  nameScreen.classList.remove('hidden');
}
function hideNameShowHome(){
  nameScreen.classList.add('hidden');
  home.classList.remove('hidden');
}
function goHome(){
  // cleanup
  clearInterval(examTimer);
  timerDisplay.textContent = '';
  resultScreen.classList.add('hidden');
  examScreen.classList.add('hidden');
  nameScreen.classList.add('hidden');
  createPaperArea.classList.add('hidden');
  pastPapersArea.classList.add('hidden');
  resultsArea.innerHTML = '';
  logArea.classList.add('hidden');
  adminPanel.classList.add('hidden');
  home.classList.remove('hidden');
}

/* -----------------------
   Admin login & panel
   ----------------------- */
function promptAdminLogin(){
  const pw = prompt('প্রশাসক পাসওয়ার্ড লিখুন:'); if(pw===null) return;
  if(pw === getAdminPass()){
    openAdminPanel();
    recordAdminLogin('login');
  } else alert('পাসওয়ার্ড মিলেনি।');
}
function openAdminPanel(){
  home.classList.add('hidden');
  nameScreen.classList.add('hidden');
  adminPanel.classList.remove('hidden');
  adminContent.innerHTML = '<div class="small">এখানে নির্দিষ্ট অপশন নির্বাচন করুন — নতুন প্রশ্নপত্র, বিগত প্রশ্নপত্র, লগ</div>';
}
function closeAdminPanel(){ adminPanel.classList.add('hidden'); home.classList.remove('hidden'); }

function recordAdminLogin(type){
  const logs = JSON.parse(localStorage.getItem(ADMIN_LOG)||'[]');
  logs.unshift({type, time: new Date().toISOString()});
  localStorage.setItem(ADMIN_LOG, JSON.stringify(logs));
}

/* -----------------------
   Create paper editor (DOM-based)
   ----------------------- */
function openCreatePaper(){
  adminPanel.classList.add('hidden');
  createPaperArea.classList.remove('hidden');
  paperTitleInput.value = '';
  paperDurationInput.value = 0;
  questionsEditor.innerHTML = '';
  examQuestions = [];
  // start with one question
  addQuestionEditor();
}
function closeCreatePaper(){
  createPaperArea.classList.add('hidden');
  adminPanel.classList.remove('hidden');
}

function addQuestionEditor(pref={}){
  // create a question editor block and push to examQuestions array
  const defaultQ = { q: pref.q || '', options: pref.options || ['','','',''], ans: pref.ans||0, point: pref.point||1, negative: pref.negative||0 };
  examQuestions.push(defaultQ);
  renderQuestionsEditor();
}

function renderQuestionsEditor(){
  questionsEditor.innerHTML = '';
  examQuestions.forEach((item, idx)=>{
    const block = el('div',{class:'admin-question'});
    // question text
    const qLabel = el('label',{},['প্রশ্ন:']);
    const qInput = el('input',{type:'text', value:item.q});
    qInput.style.marginTop = '6px';
    qInput.addEventListener('input', e=>{ examQuestions[idx].q = e.target.value; });
    block.appendChild(qLabel); block.appendChild(qInput);

    // options
    for(let i=0;i<4;i++){
      const optLabel = el('label',{},[`অপশন ${i+1}:`]);
      const optInput = el('input',{type:'text', value:item.options[i]});
      optInput.style.marginTop = '6px';
      optInput.addEventListener('input', e=>{ examQuestions[idx].options[i] = e.target.value; });
      block.appendChild(optLabel); block.appendChild(optInput);
    }

    // correct select
    const correctLabel = el('label',{},['সঠিক অপশন:']);
    const correctSelect = el('select',{});
    for(let v=0; v<4; v++){
      const opt = el('option',{value:v},[`অপশন ${v+1}`]);
      if(item.ans===v) opt.selected = true;
      correctSelect.appendChild(opt);
    }
    correctSelect.value = item.ans;
    correctSelect.addEventListener('change', e=>{ examQuestions[idx].ans = parseInt(e.target.value); });
    block.appendChild(correctLabel); block.appendChild(correctSelect);

    // point
    const pointLabel = el('label',{},['পয়েন্ট:']);
    const pointInput = el('input',{type:'number', min:0, value:item.point});
    pointInput.addEventListener('input', e=>{ examQuestions[idx].point = parseFloat(e.target.value) || 0; });
    block.appendChild(pointLabel); block.appendChild(pointInput);

    // negative
    const negLabel = el('label',{},['ভুল হলে বিয়োগ:']);
    const negSelect = el('select',{});
    [0,0.25,0.5].forEach(v=>{
      const o = el('option',{value:v},[String(v)]);
      if(Number(item.negative) === Number(v)) o.selected = true;
      negSelect.appendChild(o);
    });
    negSelect.value = item.negative;
    negSelect.addEventListener('change', e=>{ examQuestions[idx].negative = parseFloat(e.target.value); });
    block.appendChild(negLabel); block.appendChild(negSelect);

    // delete
    const delBtn = el('button',{},['প্রশ্ন মুছুন']);
    delBtn.style.marginTop = '8px';
    delBtn.addEventListener('click', ()=>{ if(confirm('মুছে ফেলতে চান?')){ examQuestions.splice(idx,1); renderQuestionsEditor(); }});
    block.appendChild(delBtn);

    questionsEditor.appendChild(block);
  });
}

/* -----------------------
   Save paper (create or overwrite)
   ----------------------- */
function saveCurrentPaper(){
  const title = paperTitleInput.value.trim();
  if(!title) return alert('শিরোনাম দিন');
  if(examQuestions.length === 0) return alert('কমপক্ষে একটি প্রশ্ন যোগ করুন');
  // validate questions
  for(const [i,q] of examQuestions.entries()){
    if(!q.q.trim()) return alert(`প্রশ্ন ${i+1} খালি আছে`);
    for(const [j,opt] of q.options.entries()){
      if(!String(opt).trim()) return alert(`প্রশ্ন ${i+1} এর অপশন ${j+1} খালি আছে`);
    }
  }
  const duration = Math.max(0, parseInt(paperDurationInput.value || 0));
  // overwrite if editKey present
  const editKey = createPaperArea.dataset.editKey;
  const key = editKey || (PAP_PREFIX + Date.now());
  const obj = { title, questions: examQuestions.slice(), created: new Date().toISOString(), duration };
  savePaperObj(key, obj);
  alert('প্রশ্নপত্র সংরক্ষণ হয়েছে');
  // cleanup
  delete createPaperArea.dataset.editKey;
  paperTitleInput.value='';
  paperDurationInput.value='0';
  examQuestions = [];
  renderQuestionsEditor();
  closeCreatePaper();
  populateExamSelect();
}

/* -----------------------
   Past papers listing
   ----------------------- */
function renderPapersList(){
  adminPanel.classList.add('hidden');
  pastPapersArea.classList.remove('hidden');
  papersList.innerHTML = '';
  resultsArea.innerHTML = '';
  const keys = getPapersKeys();
  if(keys.length===0){ papersList.appendChild(el('div',{},['কোনো প্রশ্নপত্র সংরক্ষিত নেই'])); return; }
  keys.forEach(k=>{
    const o = readPaperObj(k);
    if(!o) return;
    const row = el('div',{},[]);
    row.style.marginBottom = '8px';
    const info = el('div',{},[ `${o.title} — ${o.questions.length} প্রশ্ন — সময়: ${o.duration} মিনিট` ]);
    const btnLoad = el('button',{},['লোড পরীক্ষা']);
    btnLoad.addEventListener('click', ()=>{ loadPaperForAdmin(k); });
    const btnCopy = el('button',{},['লিংক কপি']);
    btnCopy.addEventListener('click', ()=>{ copyExamLink(k); });
    const btnExport = el('button',{},['এক্সপোর্ট JSON']);
    btnExport.addEventListener('click', ()=>{ exportExamJson(k); });
    const btnReport = el('button',{},['রিপোর্ট দেখুন']);
    btnReport.addEventListener('click', ()=>{ renderResultsForExam(k); });
    const btnDelete = el('button',{},['ডিলিট']);
    btnDelete.addEventListener('click', ()=>{ if(confirm('মুছে ফেলবেন?')){ localStorage.removeItem(k); localStorage.removeItem(k + '_results'); renderPapersList(); populateExamSelect(); }});
    const actions = el('div',{class:'actions'},[btnLoad, btnCopy, btnExport, btnReport, btnDelete]);
    row.appendChild(info); row.appendChild(actions); papersList.appendChild(row);
  });
}

function loadPaperForAdmin(key){
  const o = readPaperObj(key);
  if(!o) return alert('প্রশ্নপত্র পেয়ে না');
  // open in create editor for edit
  adminPanel.classList.add('hidden');
  createPaperArea.classList.remove('hidden');
  paperTitleInput.value = o.title || '';
  paperDurationInput.value = o.duration || 0;
  examQuestions = JSON.parse(JSON.stringify(o.questions || [])); // clone
  renderQuestionsEditor();
  // set edit key so save will overwrite
  createPaperArea.dataset.editKey = key;
}

/* -----------------------
   Copy link / export
   ----------------------- */
function copyExamLink(key){
  const url = window.location.href.split('#')[0].split('?')[0] + '?exam=' + encodeURIComponent(key);
  navigator.clipboard?.writeText(url).then(()=>{ alert('লিংক কপি হয়েছে:\n' + url); }).catch(()=>{ prompt('কপি করুন: Ctrl+C', url); });
}
function exportExamJson(key){
  const obj = readPaperObj(key); if(!obj) return alert('না পাওয়া গেল');
  const data = JSON.stringify(obj, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (obj.title || 'exam') + '.json'; a.click(); URL.revokeObjectURL(a.href);
}

/* -----------------------
   Results storage (LocalStorage)
   ----------------------- */
function saveResultToStorage(paperKey, resultObj){
  const key = paperKey + '_results';
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  arr.push(resultObj);
  localStorage.setItem(key, JSON.stringify(arr));
}
/* mark blocked */
function blockUserForPaper(paperKey, username){
  const bkey = paperKey + '_blocked';
  const arr = JSON.parse(localStorage.getItem(bkey) || '[]');
  if(!arr.includes(username)) arr.push(username);
  localStorage.setItem(bkey, JSON.stringify(arr));
}
function isUserBlocked(paperKey, username){
  const bkey = paperKey + '_blocked';
  const arr = JSON.parse(localStorage.getItem(bkey) || '[]');
  return arr.includes(username);
}

/* -----------------------
   Start exam (user)
   ----------------------- */
function populateExamSelect(){
  examSelect.innerHTML = '';
  const keys = getPapersKeys();
  if(keys.length===0){ examSelect.appendChild(el('option',{value:''},['প্রশাসক প্রথমে প্রশ্নপত্র তৈরি করুন'])); return; }
  keys.forEach(k=>{
    const o = readPaperObj(k);
    if(!o) return;
    examSelect.appendChild(el('option',{value:k},[o.title]));
  });
}

// Begin exam flow
function beginExamFlow(){
  candidateName = candidateNameInput.value.trim();
  if(!candidateName) return alert('নাম লিখুন');
  const key = examSelect.value;
  if(!key) return alert('প্রশাসক প্রথমে প্রশ্নপত্র তৈরি করুন');
  // blocked check
  if(isUserBlocked(key, candidateName)){
    return alert('আপনি ব্লক হয়েছেন — একাধিকবার চেষ্টা করার কারণে পরীক্ষায় অংশগ্রহণ করা যাবে না।');
  }
  const resultsKey = key + '_results';
  const prev = JSON.parse(localStorage.getItem(resultsKey) || '[]');
  // if previous attempt exists, block and prevent
  if(prev.some(r => (r.candidate || '').toLowerCase() === candidateName.toLowerCase())){
    // mark blocked
    blockUserForPaper(key, candidateName);
    return alert('আপনি ইতিমধ্যে এই পরীক্ষায় অংশগ্রহণ করেছেন। দ্বিতীয়বারের চেষ্টা করার কারণে আপনি ব্লক করা হলেন।');
  }

  currentPaper = key;
  const paper = readPaperObj(key);
  if(!paper) return alert('প্রশ্নপত্র পাওয়া যায়নি');
  // load questions
  examQuestions = JSON.parse(JSON.stringify(paper.questions || []));
  // set duration
  timeLeftSeconds = (paper.duration && Number(paper.duration) > 0) ? Number(paper.duration) * 60 : 0;
  // show exam
  nameScreen.classList.add('hidden');
  renderExam(paper.title);
  examScreen.classList.remove('hidden');
  // start timer if >0
  if(timeLeftSeconds > 0) startTimer(timeLeftSeconds);
  else timerDisplay.textContent = '';
}

/* -----------------------
   Render exam & timer
   ----------------------- */
function renderExam(title){
  examTitleEl.textContent = title || 'পরীক্ষা';
  questionsArea.innerHTML = '';
  examQuestions.forEach((q, i)=>{
    const qblock = el('div',{class:'question'});
    // serial number provided
    qblock.appendChild(el('div',{},[`${i+1}. ${q.q}`]));
    const opts = el('div');
    q.options.forEach((opt, j)=>{
      const id = `q_${i}_${j}`;
      const radio = el('input',{type:'radio', name:`q${i}`, value:j, id:id});
      const label = el('label',{},[ ' ', opt ]);
      // wrap
      const line = el('div');
      line.appendChild(radio); line.appendChild(label);
      opts.appendChild(line);
    });
    // NOTE: removed per-question points display as requested
    qblock.appendChild(opts);
    questionsArea.appendChild(qblock);
  });
}

function startTimer(seconds){
  clearInterval(examTimer);
  timeLeftSeconds = seconds;
  // show initial
  updateTimerDisplay();
  examTimer = setInterval(()=>{
    timeLeftSeconds--;
    updateTimerDisplay();
    if(timeLeftSeconds <= 0){
      clearInterval(examTimer);
      alert('সময় শেষ — পরীক্ষা স্বয়ংক্রিয়ভাবে সাবমিট হচ্ছে।');
      submitExam();
    }
  }, 1000);
}
function updateTimerDisplay(){
  if(timeLeftSeconds <= 0){ timerDisplay.textContent = ''; return; }
  const m = Math.floor(timeLeftSeconds / 60);
  const s = timeLeftSeconds % 60;
  timerDisplay.textContent = `বাকি সময়: ${m}m ${s}s`;
}

/* -----------------------
   Submit & scoring
   ----------------------- */
function submitExam(){
  clearInterval(examTimer);
  // collect answers and score
  let correct = 0, wrong = 0;
  let totalScore = 0;
  const perQuestion = [];
  const answers = [];
  examQuestions.forEach((q, idx)=>{
    const sel = document.querySelector(`input[name="q${idx}"]:checked`);
    const chosen = sel ? parseInt(sel.value) : null;
    answers.push(chosen);
    if(chosen === null){ perQuestion.push(0); }
    else if(chosen === q.ans){ correct++; totalScore += Number(q.point || 0); perQuestion.push(Number(q.point||0)); }
    else { wrong++; const neg = Number(q.negative || 0); totalScore -= neg; perQuestion.push(-neg); }
  });
  // compose result
  lastResult = { paperId: currentPaper, candidate: candidateName, date: new Date().toISOString(), total: totalScore, correct, wrong, perQuestion, answers };
  // save into localStorage for that paper's results
  saveResultToStorage(currentPaper, lastResult);
  // show result
  examScreen.classList.add('hidden');
  resultScreen.classList.remove('hidden');
  summaryEl.innerHTML = `<div>সঠিক: <strong>${correct}</strong> — ভুল: <strong>${wrong}</strong></div><div style="margin-top:6px">মোট প্রাপ্ত নম্বর: <strong>${Number(totalScore).toString()}</strong></div>`;
  renderDetailedAnswers();
}

/* -----------------------
   Detailed answers & CSV (participant)
   ----------------------- */
function renderDetailedAnswers(){
  detailedAnswers.innerHTML = '';
  if(!lastResult) return;
  const paper = readPaperObj(lastResult.paperId);
  if(!paper) return;
  paper.questions.forEach((q, idx)=>{
    const block = el('div',{class:'question'});
    const userAns = lastResult.answers[idx] === null || lastResult.answers[idx] === undefined ? 'উত্তর নেই' : q.options[lastResult.answers[idx]];
    const correctAns = q.options[q.ans];
    const score = lastResult.perQuestion[idx];
    block.appendChild(el('div',{},[ `${idx+1}. ${q.q}` ]));
    block.appendChild(el('div',{class:'small'},[`আপনার উত্তর: ${userAns}`]));
    block.appendChild(el('div',{class:'small'},[`সঠিক উত্তর: ${correctAns}`]));
    block.appendChild(el('div',{class:'small mark-line'},[`এই প্রশ্নের প্রাপ্ত নম্বর: ${score}`]));
    block.appendChild(el('div',{class:'small'},[`অবস্থা: ${score>0 ? 'সঠিক' : (score===0 ? 'উত্তর নেই' : 'ভুল')}`]));
    detailedAnswers.appendChild(block);
  });
  // initial hide marks if showMarks false
  renderMarksToggle();
}

function renderMarksToggle(){
  const markLines = detailedAnswers.querySelectorAll('.mark-line');
  markLines.forEach(elm=>elm.style.display = showMarks ? 'block' : 'none');
  toggleMarksBtn.textContent = showMarks ? 'মার্ক লুকান' : 'মার্কসহ উত্তর দেখুন';
}

function downloadResultCsv(result){
  const paper = readPaperObj(result.paperId);
  if(!paper) return alert('প্রশ্নপত্র পাওয়া যায়নি');
  let rows = [];
  rows.push(['Question','YourAnswer','CorrectAnswer','Score']);
  paper.questions.forEach((q, idx)=>{
    const your = result.answers[idx]===null || result.answers[idx]===undefined ? '' : q.options[result.answers[idx]];
    rows.push([q.q, your, q.options[q.ans], String(result.perQuestion[idx])]);
  });
  const csv = rows.map(r => r.map(c=>escapeCsv(c)).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  const filename = (paper.title || 'result') + '_' + (result.candidate || 'candidate') + '.csv';
  a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}

/* -----------------------
   Render results for an exam (admin) — simple table: Name | Score
   ----------------------- */
function renderResultsForExam(paperKey){
  resultsArea.innerHTML = '';
  const paper = readPaperObj(paperKey);
  if(!paper) return alert('প্রশ্নপত্র পাওয়া যায়নি');
  const resultsKey = paperKey + '_results';
  const arr = JSON.parse(localStorage.getItem(resultsKey) || '[]');
  const title = el('h4',{},[ `${paper.title} — রিপোর্ট (${arr.length} জন অংশগ্রহণকারী)` ]);
  const btnExport = el('button',{},['Export CSV']);
  btnExport.addEventListener('click', ()=>{ exportExamResultsCsv(paperKey); });
  const btnBack = el('button',{},['Back to list']);
  btnBack.addEventListener('click', ()=>{ resultsArea.innerHTML=''; });
  resultsArea.appendChild(title);
  resultsArea.appendChild(btnExport);
  resultsArea.appendChild(btnBack);

  if(arr.length===0){
    resultsArea.appendChild(el('div',{},['কোনো অংশগ্রহণকারীর ফলাফল নেই'])); return;
  }

  const table = el('table');
  const thead = el('thead');
  const headerRow = el('tr');
  ['#','Name','Score'].forEach(h=> headerRow.appendChild(el('th',{},[h])));
  thead.appendChild(headerRow); table.appendChild(thead);
  const tbody = el('tbody');
  arr.forEach((res, idx)=>{
    const tr = el('tr');
    tr.appendChild(el('td',{},[String(idx+1)]));
    tr.appendChild(el('td',{},[res.candidate || '']));
    tr.appendChild(el('td',{},[ String(res.total) ]));
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  resultsArea.appendChild(table);
}

/* -----------------------
   Export exam results (admin CSV)
   ----------------------- */
function exportExamResultsCsv(paperKey){
  const paper = readPaperObj(paperKey);
  if(!paper) return alert('প্রশ্নপত্র পাওয়া যায়নি');
  const resultsKey = paperKey + '_results';
  const arr = JSON.parse(localStorage.getItem(resultsKey) || '[]');
  if(arr.length===0) return alert('কোনো ফলাফল নেই');

  // header
  const headers = ['Name','Date','Total','Correct','Wrong'];
  for(let i=0;i<paper.questions.length;i++){
    headers.push(`Q${i+1}_Your`);
    headers.push(`Q${i+1}_Correct`);
    headers.push(`Q${i+1}_Score`);
  }
  const rows = [headers];
  arr.forEach(res=>{
    const row = [res.candidate || '', res.date, String(res.total), String(res.correct), String(res.wrong)];
    for(let q=0;q<paper.questions.length;q++){
      const your = (res.answers[q] === null || res.answers[q]===undefined) ? '' : (paper.questions[q].options[res.answers[q]] || '');
      const correct = paper.questions[q].options[paper.questions[q].ans] || '';
      const score = String(res.perQuestion[q] || 0);
      row.push(your, correct, score);
    }
    rows.push(row);
  });

  const csv = rows.map(r => r.map(c=>escapeCsv(c)).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (paper.title || 'exam') + '_results.csv';
  a.click(); URL.revokeObjectURL(a.href);
}

/* -----------------------
   Logs
   ----------------------- */
function renderLogs(){
  adminPanel.classList.add('hidden');
  logArea.classList.remove('hidden');
  const logs = JSON.parse(localStorage.getItem(ADMIN_LOG) || '[]');
  loginRecords.innerHTML = '';
  if(logs.length===0) return loginRecords.appendChild(el('div',{},['কোনো রেকর্ড নেই']));
  logs.forEach(l=>{
    const d = new Date(l.time);
    loginRecords.appendChild(el('div',{},[`${l.type} — ${d.toLocaleString()}`]));
  });
}

/* -----------------------
   Page load handling (query param)
   ----------------------- */
function handleQueryParam(){
  const params = new URLSearchParams(window.location.search);
  const examParam = params.get('exam');
  populateExamSelect();
  if(examParam && localStorage.getItem(examParam)){
    // preselect exam and show name screen
    showNameScreen();
    examSelect.value = examParam;
    // name still required
  }
}

/* -----------------------
   On load
   ----------------------- */
window.addEventListener('load', ()=>{
  handleQueryParam();
});

/* -----------------------
   Helper: expose some functions for debugging (optional)
   ----------------------- */
window._tw = {
  listExams: getPapersKeys,
  readExam: readPaperObj,
  copyExamLink,
  exportExamJson,
  exportExamResultsCsv
};
</script>
</body>
</html>